---
- name: Deploy Flask App using Docker
  hosts: all
  become: yes
  vars:
    image: "{{ image_ref }}"
  tasks:
    - name: Check if docker exists
      command: bash -lc "command -v docker || true"
      register: docker_cmd
      changed_when: false

    - name: Install Docker via script if missing
      shell: |
        set -e
        chmod +x {{ playbook_dir }}/../get-docker.sh || true
        sudo sh {{ playbook_dir }}/../get-docker.sh
      when: docker_cmd.stdout == ""
      args:
        executable: /bin/bash

    - name: Ensure docker service is started
      service:
        name: docker
        state: started
        enabled: yes

    - name: Verify Docker service
      shell: systemctl is-active docker
      register: docker_status
      changed_when: false
      failed_when: docker_status.stdout.strip() != "active"

    - name: Log in to GHCR (only if private)
      command: >
        docker login ghcr.io
        -u {{ lookup('env','GHCR_USER') }}
        --password {{ lookup('env','GHCR_PAT') }}
      register: ghcr_login
      changed_when: "'Login Succeeded' in ghcr_login.stdout"
      retries: 3
      delay: 5
      until: ghcr_login.rc == 0
      when: ghcr_private | bool

    - name: Pull Flask application image
      command: docker pull {{ image }}
      register: pull_result
      retries: 3
      delay: 5
      until: pull_result.rc == 0
      ignore_errors: no

    - name: Stop existing container if running
      command: docker stop capstone_flask
      ignore_errors: yes

    - name: Remove old container if exists
      command: docker rm capstone_flask
      ignore_errors: yes

    - name: Run application container
      command: >
        docker run -d --name capstone_flask
        -p {{ app_port }}:5000
        {{ image }}

    - name: Wait for Flask application to start
      uri:
        url: "http://localhost:{{ app_port }}/api/health"
        method: GET
        status_code: 200
      register: app_status
      retries: 15
      delay: 4
      until: app_status.status == 200

    - name: Display success message
      debug:
        msg: "âœ… Flask application deployed successfully and is healthy!"
