name: Optimized CI with Advanced Caching - Ubuntu

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  cache-strategy-demo:
    name: Advanced Ubuntu Caching Strategies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Cache Node.js modules
      uses: actions/cache@v3
      id: node-cache
      with:
        path: ~/.npm
        key: ubuntu-node-${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ubuntu-node-${{ env.NODE_VERSION }}-
          ubuntu-node-
          
    - name: Node cache status
      run: |
        if [ "${{ steps.node-cache.outputs.cache-hit }}" == "true" ]; then
          echo "::notice title=Cache Hit::Node.js dependencies loaded from Ubuntu cache"
          echo "Cache HIT - Node.js modules restored from Ubuntu cache"
        else
          echo "::notice title=Cache Miss::Node.js dependencies will be downloaded on Ubuntu"
          echo "Cache MISS - Will download Node.js modules on Ubuntu"
        fi
        
    - name: Cache Python packages
      uses: actions/cache@v3
      id: python-cache
      with:
        path: ~/.cache/pip
        key: ubuntu-python-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ubuntu-python-${{ env.PYTHON_VERSION }}-
          ubuntu-python-
          
    - name: Python cache status
      run: |
        if [ "${{ steps.python-cache.outputs.cache-hit }}" == "true" ]; then
          echo "::notice title=Cache Hit::Python packages loaded from Ubuntu cache"
          echo "Cache HIT - Python packages restored from Ubuntu cache"
        else
          echo "::notice title=Cache Miss::Python packages will be downloaded on Ubuntu"
          echo "Cache MISS - Will download Python packages on Ubuntu"
        fi
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install Node.js dependencies (timed)
      run: |
        echo "Starting Node.js installation on Ubuntu at $(date)"
        start_time=$(date +%s)
        npm ci
        end_time=$(date +%s)
        duration=$((end_time - start_time))
        echo "Node.js installation completed in ${duration} seconds on Ubuntu"
        echo "::notice title=Ubuntu Install Time::Node.js dependencies installed in ${duration}s"
        
    - name: Install Python dependencies (timed)
      run: |
        echo "Starting Python installation on Ubuntu at $(date)"
        start_time=$(date +%s)
        pip install -r requirements.txt
        end_time=$(date +%s)
        duration=$((end_time - start_time))
        echo "Python installation completed in ${duration} seconds on Ubuntu"
        echo "::notice title=Ubuntu Install Time::Python dependencies installed in ${duration}s"
        
    - name: Generate cache performance report
      run: |
        echo "# Ubuntu Cache Performance Report" > cache-performance.md
        echo "" >> cache-performance.md
        echo "**Date:** $(date)" >> cache-performance.md
        echo "**Platform:** Ubuntu Latest" >> cache-performance.md
        echo "" >> cache-performance.md
        echo "## Cache Status" >> cache-performance.md
        echo "- Node.js Cache: ${{ steps.node-cache.outputs.cache-hit == 'true' && 'HIT' || 'MISS' }}" >> cache-performance.md
        echo "- Python Cache: ${{ steps.python-cache.outputs.cache-hit == 'true' && 'HIT' || 'MISS' }}" >> cache-performance.md
        echo "" >> cache-performance.md
        echo "## Expected Performance Gains" >> cache-performance.md
        echo "- Cache Hit: 60-80% faster installation" >> cache-performance.md
        echo "- Ubuntu Consistency: Additional 10-15% improvement" >> cache-performance.md
        
        cat cache-performance.md
        
    - name: Upload cache performance report
      uses: actions/upload-artifact@v4
      with:
        name: cache-performance-ubuntu
        path: cache-performance.md

  ubuntu-performance-metrics:
    name: Ubuntu Performance Analysis
    runs-on: ubuntu-latest
    needs: cache-strategy-demo
    
    steps:
    - name: Generate performance analysis
      run: |
        echo "# Ubuntu Performance Analysis Report" > performance-analysis.txt
        echo "========================================" >> performance-analysis.txt
        echo "" >> performance-analysis.txt
        echo "Platform: Ubuntu Latest" >> performance-analysis.txt
        echo "Analysis Date: $(date)" >> performance-analysis.txt
        echo "" >> performance-analysis.txt
        echo "Ubuntu Performance Benefits:" >> performance-analysis.txt
        echo "- Consistent filesystem paths" >> performance-analysis.txt
        echo "- Reliable package manager behavior" >> performance-analysis.txt
        echo "- Predictable dependency resolution" >> performance-analysis.txt
        echo "- Optimized for GitHub Actions runners" >> performance-analysis.txt
        echo "- No Windows path or macOS permission issues" >> performance-analysis.txt
        
        cat performance-analysis.txt
        
    - name: Upload performance analysis
      uses: actions/upload-artifact@v4
      with:
        name: performance-analysis-ubuntu
        path: performance-analysis.txt
